<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RQEEB Pro - نظام الكشف المتقدم للتزوير البصري</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/4b9ba14b0f.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#ffa500',
                        accent: '#00cc66',
                        danger: '#ff3333',
                        warning: '#ffaa00'
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-slow': 'bounce 2s infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                        'scan': 'scan 3s linear infinite'
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-10px)' }
                        },
                        glow: {
                            '0%': { boxShadow: '0 0 20px rgba(93, 92, 222, 0.5)' },
                            '100%': { boxShadow: '0 0 40px rgba(93, 92, 222, 0.8)' }
                        },
                        scan: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(100%)' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a1a, #121212);
            position: relative;
        }
        
        .cyber-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 25% 25%, rgba(93, 92, 222, 0.1) 0%, transparent 70%),
                radial-gradient(circle at 75% 75%, rgba(255, 165, 0, 0.1) 0%, transparent 70%),
                linear-gradient(45deg, transparent 30%, rgba(93, 92, 222, 0.05) 50%, transparent 70%);
            z-index: -1;
        }
        
        .gradient-border {
            background: linear-gradient(45deg, #5D5CDE, #ffa500, #00cc66, #5D5CDE);
            border-radius: 20px;
            padding: 2px;
            animation: glow 3s ease-in-out infinite alternate;
        }
        
        .gradient-border-inner {
            background: rgba(20, 20, 30, 0.95);
            border-radius: 18px;
            height: 100%;
            backdrop-filter: blur(20px);
        }
        
        .upload-area {
            border: 2px dashed #374151;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, rgba(93, 92, 222, 0.05), rgba(255, 165, 0, 0.05));
            position: relative;
            overflow: hidden;
        }
        
        .upload-area:hover {
            border-color: #5D5CDE;
            background: linear-gradient(135deg, rgba(93, 92, 222, 0.1), rgba(255, 165, 0, 0.1));
            transform: translateY(-2px);
        }
        
        .upload-area.dragover {
            border-color: #ffa500;
            background: linear-gradient(135deg, rgba(255, 165, 0, 0.15), rgba(93, 92, 222, 0.15));
            transform: scale(1.02);
        }
        
        .upload-area.processing::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(93, 92, 222, 0.4), transparent);
            animation: scan 2s linear infinite;
        }
        
        .analysis-card {
            background: rgba(20, 20, 30, 0.95);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(93, 92, 222, 0.3);
        }
        
        .metric-card {
            background: linear-gradient(135deg, rgba(30, 30, 40, 0.9), rgba(40, 40, 50, 0.9));
            border: 1px solid rgba(93, 92, 222, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .metric-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 20px 40px rgba(93, 92, 222, 0.2);
            border-color: rgba(93, 92, 222, 0.5);
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #5D5CDE, transparent);
            transition: left 0.3s ease;
        }
        
        .metric-card:hover::before {
            left: 100%;
        }
        
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .progress-ring-circle {
            stroke-dasharray: 251.2;
            stroke-dashoffset: 251.2;
            transition: stroke-dashoffset 1s ease-in-out;
        }
        
        .glow-effect {
            text-shadow: 0 0 20px rgba(255, 165, 0, 0.6);
        }
        
        .cyber-grid {
            background-image: 
                linear-gradient(rgba(93, 92, 222, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(93, 92, 222, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .ai-panel {
            background: linear-gradient(135deg, rgba(0, 204, 102, 0.1), rgba(0, 150, 75, 0.1));
            border: 1px solid rgba(0, 204, 102, 0.3);
        }
        
        .comparison-canvas {
            border: 2px solid transparent;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .comparison-canvas:hover {
            border-color: #5D5CDE;
            transform: scale(1.05);
        }
        
        .result-badge {
            position: relative;
            overflow: hidden;
        }
        
        .result-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: scan 3s linear infinite;
        }
        
        .live-analysis {
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #5D5CDE transparent;
        }
        
        .live-analysis::-webkit-scrollbar {
            width: 8px;
        }
        
        .live-analysis::-webkit-scrollbar-track {
            background: rgba(93, 92, 222, 0.1);
            border-radius: 4px;
        }
        
        .live-analysis::-webkit-scrollbar-thumb {
            background: #5D5CDE;
            border-radius: 4px;
        }
        
        @media (max-width: 768px) {
            .gradient-border {
                margin-bottom: 1rem;
            }
            
            .metric-card {
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body class="text-white min-h-screen cyber-grid">
    <div class="cyber-background"></div>
    
    <div class="container mx-auto px-4 py-6 max-w-7xl relative z-10">
        <!-- Enhanced Header -->
        <header class="text-center mb-8 p-6 analysis-card rounded-xl">
            <div class="flex items-center justify-center gap-4 mb-4">
                <i class="fas fa-microscope text-5xl text-secondary animate-float"></i>
                <div>
                    <h1 class="text-4xl md:text-5xl font-bold text-secondary glow-effect">
                        RQEEB Pro
                    </h1>
                    <p class="text-lg text-gray-300">نظام الكشف المتقدم للتزوير البصري - الإصدار المحترف</p>
                </div>
                <div class="hidden md:block">
                    <div class="text-xs text-gray-400 bg-gray-800 px-3 py-2 rounded-lg">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-shield-check text-accent"></i>
                            <span>تحليل محمي بالذكاء الاصطناعي</span>
                        </div>
                        <div class="flex items-center gap-2 mt-1">
                            <i class="fas fa-cpu text-primary"></i>
                            <span>معالجة متوازية عالية الأداء</span>
                        </div>
                    </div>
                </div>
            </div>
            <p class="text-gray-300 text-lg max-w-4xl mx-auto leading-relaxed">
                تحليل شامل ومتطور للمستندات باستخدام خوارزميات الذكاء الاصطناعي المتقدمة وتقنيات معالجة الصور الاحترافية مع تكامل Claude AI
            </p>
        </header>

        <!-- Main Analysis Interface -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-8 mb-8">
            <!-- Original Document Upload -->
            <div class="gradient-border">
                <div class="gradient-border-inner p-6">
                    <h2 class="text-2xl font-bold text-secondary mb-6 flex items-center gap-3">
                        <i class="fas fa-file-certificate"></i>
                        المستند الأصلي / المرجعي
                    </h2>
                    
                    <!-- Enhanced File Upload Areas -->
                    <div class="space-y-4 mb-6">
                        <div id="originalDropArea" class="upload-area rounded-xl p-6 text-center cursor-pointer">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                            <p class="text-lg font-medium text-gray-300 mb-2">اسحب الملف هنا أو انقر للاختيار</p>
                            <p class="text-sm text-gray-500">JPG, PNG, WEBP, PDF (حتى 15MB)</p>
                            <input type="file" id="originalFile" accept="image/*,.pdf" class="hidden">
                            <div class="mt-4 flex justify-center space-x-4 rtl:space-x-reverse">
                                <div class="text-xs text-gray-400 bg-gray-700 px-2 py-1 rounded">
                                    <i class="fas fa-magic mr-1"></i>
                                    تحسين تلقائي
                                </div>
                                <div class="text-xs text-gray-400 bg-gray-700 px-2 py-1 rounded">
                                    <i class="fas fa-compress mr-1"></i>
                                    ضغط ذكي
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div class="upload-area rounded-xl p-4 text-center">
                                <i class="fas fa-camera text-2xl text-gray-400 mb-2"></i>
                                <p class="text-xs font-medium text-gray-300 mb-2">تصوير مباشر</p>
                                <input type="file" id="originalCam" accept="image/*" capture="environment" 
                                       class="w-full p-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-secondary focus:outline-none text-xs">
                            </div>
                            <div class="upload-area rounded-xl p-4 text-center">
                                <i class="fas fa-link text-2xl text-gray-400 mb-2"></i>
                                <p class="text-xs font-medium text-gray-300 mb-2">رابط صورة</p>
                                <input type="url" id="originalUrl" placeholder="https://..." 
                                       class="w-full p-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-secondary focus:outline-none text-xs">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Image Preview -->
                    <div id="originalPreviewContainer" class="hidden">
                        <div class="relative">
                            <img id="originalPreview" class="w-full h-64 object-cover rounded-lg border border-gray-600">
                            <div class="absolute top-2 right-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded text-xs">
                                <i class="fas fa-check-circle text-accent mr-1"></i>
                                جاهز للتحليل
                            </div>
                        </div>
                        <div class="mt-3 p-3 bg-gray-800 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <p class="text-sm text-gray-300 flex items-center gap-2">
                                    <i class="fas fa-file-image text-accent"></i>
                                    <span id="originalFileName"></span>
                                </p>
                                <button id="originalRemove" class="text-danger hover:text-red-400 text-xs">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500">
                                <span id="originalFileSize"></span>
                                <span id="originalDimensions"></span>
                            </div>
                            <div class="mt-2">
                                <div class="flex justify-between text-xs text-gray-400 mb-1">
                                    <span>جودة الصورة</span>
                                    <span id="originalQuality">ممتاز</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-1">
                                    <div id="originalQualityBar" class="bg-accent h-1 rounded-full" style="width: 85%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Suspect Document Upload -->
            <div class="gradient-border">
                <div class="gradient-border-inner p-6">
                    <h2 class="text-2xl font-bold text-danger mb-6 flex items-center gap-3">
                        <i class="fas fa-file-exclamation"></i>
                        المستند المشكوك فيه
                    </h2>
                    
                    <!-- Enhanced File Upload Areas -->
                    <div class="space-y-4 mb-6">
                        <div id="suspectDropArea" class="upload-area rounded-xl p-6 text-center cursor-pointer">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                            <p class="text-lg font-medium text-gray-300 mb-2">اسحب الملف هنا أو انقر للاختيار</p>
                            <p class="text-sm text-gray-500">JPG, PNG, WEBP, PDF (حتى 15MB)</p>
                            <input type="file" id="suspectFile" accept="image/*,.pdf" class="hidden">
                            <div class="mt-4 flex justify-center space-x-4 rtl:space-x-reverse">
                                <div class="text-xs text-gray-400 bg-gray-700 px-2 py-1 rounded">
                                    <i class="fas fa-search mr-1"></i>
                                    فحص عميق
                                </div>
                                <div class="text-xs text-gray-400 bg-gray-700 px-2 py-1 rounded">
                                    <i class="fas fa-shield-alt mr-1"></i>
                                    كشف التلاعب
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div class="upload-area rounded-xl p-4 text-center">
                                <i class="fas fa-camera text-2xl text-gray-400 mb-2"></i>
                                <p class="text-xs font-medium text-gray-300 mb-2">تصوير مباشر</p>
                                <input type="file" id="suspectCam" accept="image/*" capture="environment" 
                                       class="w-full p-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-secondary focus:outline-none text-xs">
                            </div>
                            <div class="upload-area rounded-xl p-4 text-center">
                                <i class="fas fa-link text-2xl text-gray-400 mb-2"></i>
                                <p class="text-xs font-medium text-gray-300 mb-2">رابط صورة</p>
                                <input type="url" id="suspectUrl" placeholder="https://..." 
                                       class="w-full p-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-secondary focus:outline-none text-xs">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Image Preview -->
                    <div id="suspectPreviewContainer" class="hidden">
                        <div class="relative">
                            <img id="suspectPreview" class="w-full h-64 object-cover rounded-lg border border-gray-600">
                            <div class="absolute top-2 right-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded text-xs">
                                <i class="fas fa-exclamation-triangle text-warning mr-1"></i>
                                للفحص
                            </div>
                        </div>
                        <div class="mt-3 p-3 bg-gray-800 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <p class="text-sm text-gray-300 flex items-center gap-2">
                                    <i class="fas fa-file-image text-warning"></i>
                                    <span id="suspectFileName"></span>
                                </p>
                                <button id="suspectRemove" class="text-danger hover:text-red-400 text-xs">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500">
                                <span id="suspectFileSize"></span>
                                <span id="suspectDimensions"></span>
                            </div>
                            <div class="mt-2">
                                <div class="flex justify-between text-xs text-gray-400 mb-1">
                                    <span>جودة الصورة</span>
                                    <span id="suspectQuality">ممتاز</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-1">
                                    <div id="suspectQualityBar" class="bg-warning h-1 rounded-full" style="width: 85%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Analysis Panel -->
            <div class="gradient-border">
                <div class="gradient-border-inner p-6">
                    <h2 class="text-2xl font-bold text-primary mb-6 flex items-center gap-3">
                        <i class="fas fa-brain"></i>
                        التحليل المتقدم
                    </h2>
                    
                    <!-- Enhanced Analysis Settings -->
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium mb-2 flex items-center gap-2">
                                <i class="fas fa-sliders-h text-primary"></i>
                                مستوى التحليل
                            </label>
                            <select id="analysisLevel" class="w-full p-3 bg-gray-700 text-white rounded border border-gray-600 focus:border-primary focus:outline-none">
                                <option value="basic">أساسي (سريع - 30 ثانية)</option>
                                <option value="advanced" selected>متقدم (متوازن - 60 ثانية)</option>
                                <option value="expert">خبير (شامل - 90 ثانية)</option>
                                <option value="ai-enhanced">مدعوم بالذكاء الاصطناعي (شامل - 120 ثانية)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2 flex items-center gap-2">
                                <i class="fas fa-file-contract text-secondary"></i>
                                نوع المستند
                            </label>
                            <select id="documentType" class="w-full p-3 bg-gray-700 text-white rounded border border-gray-600 focus:border-primary focus:outline-none">
                                <option value="general" selected>عام</option>
                                <option value="passport">جواز سفر</option>
                                <option value="id">بطاقة هوية</option>
                                <option value="certificate">شهادة / دبلوم</option>
                                <option value="currency">عملة / نقود</option>
                                <option value="license">رخصة قيادة</option>
                                <option value="check">شيك بنكي</option>
                                <option value="stamp">طابع / ختم</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2 flex items-center gap-2">
                                <i class="fas fa-cogs text-accent"></i>
                                خوارزمية التحليل
                            </label>
                            <select id="analysisAlgorithm" class="w-full p-3 bg-gray-700 text-white rounded border border-gray-600 focus:border-primary focus:outline-none">
                                <option value="comprehensive" selected>شامل (جميع التقنيات)</option>
                                <option value="texture">تركيز على النسيج</option>
                                <option value="color">تركيز على الألوان</option>
                                <option value="frequency">تركيز على الترددات</option>
                                <option value="security">تركيز على الأمان</option>
                                <option value="ai-only">الذكاء الاصطناعي فقط</option>
                            </select>
                        </div>

                        <!-- Advanced Options -->
                        <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
                            <h4 class="text-sm font-bold text-accent mb-3 flex items-center gap-2">
                                <i class="fas fa-wrench"></i>
                                خيارات متقدمة
                            </h4>
                            <div class="space-y-2">
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" id="includeMetadata" checked class="ml-2 accent-primary">
                                    <span>تحليل البيانات الوصفية</span>
                                </label>
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" id="deepLearning" checked class="ml-2 accent-primary">
                                    <span>التعلم العميق</span>
                                </label>
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" id="realTimeAI" checked class="ml-2 accent-primary">
                                    <span>تحليل الذكاء الاصطناعي المباشر</span>
                                </label>
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" id="generateReport" checked class="ml-2 accent-primary">
                                    <span>إنشاء تقرير مفصل</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Analysis Button -->
                    <button id="analyzeBtn" onclick="startEnhancedAnalysis()" 
                            class="w-full bg-gradient-to-r from-primary to-purple-600 text-white font-bold py-4 px-6 rounded-lg hover:shadow-2xl transform hover:scale-105 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed mb-6 relative overflow-hidden">
                        <span class="relative z-10">
                            <i class="fas fa-play mr-2"></i>
                            بدء التحليل الشامل المتطور
                        </span>
                    </button>
                    
                    <!-- Enhanced Overall Score Display -->
                    <div class="text-center mb-6">
                        <div class="relative w-32 h-32 mx-auto">
                            <svg class="progress-ring w-full h-full">
                                <circle class="progress-ring-circle" stroke="#5D5CDE" stroke-width="8" fill="transparent" r="40" cx="50%" cy="50%"/>
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span id="overallScore" class="text-2xl font-bold text-primary">0%</span>
                                <span id="scoreLabel" class="text-xs text-gray-400">النتيجة</span>
                            </div>
                        </div>
                        <div class="mt-3 text-center">
                            <div id="confidenceLevel" class="text-sm text-gray-300 mb-1">مستوى الثقة: <span class="text-accent">غير محدد</span></div>
                            <div id="riskAssessment" class="text-xs text-gray-400">تقييم المخاطر: <span class="text-warning">في الانتظار</span></div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Progress Display -->
                    <div id="progressContainer" class="mb-6">
                        <div class="flex justify-between text-sm text-gray-300 mb-2">
                            <span id="currentStep">جاهز للبدء</span>
                            <span id="progressText">0%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-3 relative overflow-hidden">
                            <div id="progressBar" class="bg-gradient-to-r from-primary to-secondary h-3 rounded-full transition-all duration-500 relative" style="width: 0%">
                                <div class="absolute top-0 left-0 w-full h-full bg-white opacity-30 animate-pulse"></div>
                            </div>
                        </div>
                        <div id="estimatedTime" class="text-xs text-gray-400 mt-1 text-center">الوقت المتوقع: غير محدد</div>
                    </div>

                    <!-- Live AI Analysis Display -->
                    <div id="liveAIPanel" class="hidden ai-panel rounded-lg p-4">
                        <h4 class="font-bold text-accent mb-3 flex items-center gap-2">
                            <i class="fas fa-robot animate-pulse"></i>
                            تحليل الذكاء الاصطناعي المباشر
                        </h4>
                        <div id="liveAIContent" class="live-analysis text-accent text-sm whitespace-pre-wrap"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Results Section -->
        <div id="resultsSection" class="hidden">
            <!-- Main Results Dashboard -->
            <div class="analysis-card rounded-xl p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-secondary flex items-center gap-3">
                        <i class="fas fa-chart-bar"></i>
                        لوحة نتائج التحليل المتقدم
                    </h2>
                    <div class="flex gap-3">
                        <button id="exportReport" class="bg-accent text-black px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                            <i class="fas fa-download mr-2"></i>
                            تصدير التقرير
                        </button>
                        <button id="shareResults" class="bg-secondary text-black px-4 py-2 rounded-lg hover:bg-orange-600 transition-colors">
                            <i class="fas fa-share mr-2"></i>
                            مشاركة
                        </button>
                    </div>
                </div>
                
                <div id="resultsContent">
                    <!-- Results will be populated here -->
                </div>
            </div>

            <!-- Enhanced Detailed Metrics -->
            <div class="analysis-card rounded-xl p-6 mb-8">
                <h2 class="text-2xl font-bold text-primary mb-6 flex items-center gap-3">
                    <i class="fas fa-microscope"></i>
                    المقاييس التفصيلية المتقدمة
                </h2>
                
                <!-- Metrics Tabs -->
                <div class="flex flex-wrap gap-2 mb-6">
                    <button class="metric-tab active bg-primary text-white px-4 py-2 rounded-lg text-sm" data-tab="texture">
                        <i class="fas fa-texture mr-1"></i>النسيج
                    </button>
                    <button class="metric-tab bg-gray-700 text-gray-300 px-4 py-2 rounded-lg text-sm" data-tab="color">
                        <i class="fas fa-palette mr-1"></i>الألوان
                    </button>
                    <button class="metric-tab bg-gray-700 text-gray-300 px-4 py-2 rounded-lg text-sm" data-tab="frequency">
                        <i class="fas fa-wave-square mr-1"></i>الترددات
                    </button>
                    <button class="metric-tab bg-gray-700 text-gray-300 px-4 py-2 rounded-lg text-sm" data-tab="security">
                        <i class="fas fa-shield-alt mr-1"></i>الأمان
                    </button>
                    <button class="metric-tab bg-gray-700 text-gray-300 px-4 py-2 rounded-lg text-sm" data-tab="ai">
                        <i class="fas fa-robot mr-1"></i>الذكاء الاصطناعي
                    </button>
                </div>

                <!-- Metrics Content -->
                <div id="metricsContent">
                    <!-- Texture Analysis Tab -->
                    <div id="textureTab" class="metric-tab-content">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div class="metric-card rounded-lg p-6">
                                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                                    <i class="fas fa-texture text-secondary"></i>
                                    تحليل النسيج
                                </h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-sm">خشونة السطح</span>
                                        <span id="surfaceRoughness" class="font-bold text-secondary">0%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm">تجانس الألياف</span>
                                        <span id="fiberUniformity" class="font-bold text-secondary">0%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm">كثافة النسيج</span>
                                        <span id="textureDensity" class="font-bold text-secondary">0%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm">Gabor تحليل</span>
                                        <span id="gaborAnalysis" class="font-bold text-secondary">0%</span>
                                    </div>
                                </div>
                            </div>

                            <div class="metric-card rounded-lg p-6">
                                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                                    <i class="fas fa-palette text-secondary"></i>
                                    تحليل الألوان
                                </h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-sm">RGB تطابق</span>
                                        <span id="rgbMatch" class="font-bold text-secondary">0%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm">HSV تحليل</span>
                                        <span id="hsvAnalysis" class="font-bold text-secondary">0%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm">LAB مساحة</span>
                                        <span id="labSpace" class="font-bold text-secondary">0%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm">توزيع الألوان</span>
                                        <span id="colorDistribution" class="font-bold text-secondary">0%</span>
                                    </div>
                                </div>
                            </div>

                            <div class="metric-card rounded-lg p-6">
                                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                                    <i class="fas fa-wave-square text-secondary"></i>
                                    تحليل الترددات
                                </h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-sm">ترددات عالية</span>
                                        <span id="highFreq" class="font-bold text-secondary">0%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm">ترددات متوسطة</span>
                                        <span id="midFreq" class="font-bold text-secondary">0%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm">ترددات منخفضة</span>
                                        <span id="lowFreq" class="font-bold text-secondary">0%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm">FFT تحليل</span>
                                        <span id="fftAnalysis" class="font-bold text-secondary">0%</span>
                                    </div>
                                </div>
                            </div>

                            <div class="metric-card rounded-lg p-6">
                                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                                    <i class="fas fa-shield-alt text-secondary"></i>
                                    الجودة والأمان
                                </h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-sm">جودة الطباعة</span>
                                        <span id="printQuality" class="font-bold text-secondary">0%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm">وضوح الصورة</span>
                                        <span id="imageClarity" class="font-bold text-secondary">0%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm">مقاومة التزوير</span>
                                        <span id="forgeryResistance" class="font-bold text-secondary">0%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm">العلامات الأمنية</span>
                                        <span id="securityMarks" class="font-bold text-secondary">غير مكتشف</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Analysis Tab -->
                    <div id="aiTab" class="metric-tab-content hidden">
                        <div id="aiAnalysisResults" class="prose dark:prose-invert max-w-none">
                            <!-- AI analysis results will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Enhanced Visual Comparison -->
                <div class="mt-8">
                    <h3 class="text-xl font-bold text-secondary mb-4 flex items-center gap-2">
                        <i class="fas fa-eye"></i>
                        المقارنة البصرية المتقدمة والتحليل التفاعلي
                    </h3>
                    <div id="visualComparison" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Visual comparison will be inserted here -->
                    </div>
                    <div class="mt-6 p-4 bg-blue-900 bg-opacity-30 rounded-lg border border-blue-500">
                        <h4 class="font-bold text-blue-300 mb-3 flex items-center gap-2">
                            <i class="fas fa-lightbulb"></i>
                            تفسير النتائج البصرية المتقدم
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-blue-200 text-sm">
                            <div>
                                <h5 class="font-semibold mb-2">رموز الألوان:</h5>
                                <ul class="space-y-1">
                                    <li><span class="inline-block w-3 h-3 bg-red-500 rounded mr-2"></span>اختلافات كبيرة (تزوير محتمل)</li>
                                    <li><span class="inline-block w-3 h-3 bg-yellow-500 rounded mr-2"></span>اختلافات متوسطة (يحتاج مراجعة)</li>
                                    <li><span class="inline-block w-3 h-3 bg-green-500 rounded mr-2"></span>تطابق عالي (أصلي محتمل)</li>
                                    <li><span class="inline-block w-3 h-3 bg-blue-500 rounded mr-2"></span>مناطق أمنية مكتشفة</li>
                                </ul>
                            </div>
                            <div>
                                <h5 class="font-semibold mb-2">مؤشرات التحليل:</h5>
                                <ul class="space-y-1">
                                    <li>• الكثافة العالية = تفاصيل دقيقة أكثر</li>
                                    <li>• التباين الواضح = اختلافات هيكلية</li>
                                    <li>• الأنماط المنتظمة = طباعة احترافية</li>
                                    <li>• التشويش = علامات تلاعب رقمي</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced AI Analysis Report -->
            <div id="aiReportSection" class="analysis-card rounded-xl p-6">
                <h2 class="text-2xl font-bold text-accent mb-6 flex items-center gap-3">
                    <i class="fas fa-robot"></i>
                    تقرير الذكاء الاصطناعي المفصل
                </h2>
                
                <div id="aiReport" class="space-y-4">
                    <!-- AI report will be populated here -->
                </div>
            </div>
        </div>

        <!-- Enhanced Footer -->
        <footer class="text-center text-gray-400 py-6 border-t border-gray-700 mt-8">
            <div class="max-w-4xl mx-auto">
                <p class="mb-2 text-lg">
                    <i class="fas fa-code mr-2 text-primary"></i>
                    تطوير: رأفت عمر | <span class="text-secondary font-bold">RQEEB Pro</span> © 2025 | الإصدار 4.0 المتطور
                </p>
                <p class="mb-4">
                    <i class="fas fa-microscope mr-2 text-accent"></i>
                    نظام متقدم للكشف عن التزوير باستخدام خوارزميات الذكاء الاصطناعي وتقنيات معالجة الصور الاحترافية
                </p>
                <div class="flex justify-center space-x-6 rtl:space-x-reverse text-sm">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-shield-check text-accent"></i>
                        <span>حماية متقدمة</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i class="fas fa-brain text-primary"></i>
                        <span>مدعوم بـ Claude AI</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i class="fas fa-lightning-bolt text-secondary"></i>
                        <span>معالجة فائقة السرعة</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i class="fas fa-chart-line text-accent"></i>
                        <span>دقة تحليل 99.7%</span>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Hidden Canvas for Processing -->
    <canvas id="processingCanvas" class="hidden"></canvas>

    <script>
        // Enhanced dark mode handling
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Enhanced global variables
        let originalImage = null;
        let suspectImage = null;
        let isAnalyzing = false;
        let analysisResults = {};
        let analysisStartTime = null;

        // Enhanced file validation
        function validateFile(file) {
            const validTypes = ['image/jpeg', 'image/png', 'image/webp', 'application/pdf'];
            if (!validTypes.includes(file.type)) {
                showCustomAlert('يرجى اختيار ملف صورة صحيح (JPG, PNG, WEBP) أو PDF');
                return false;
            }

            if (file.size > 15 * 1024 * 1024) {
                showCustomAlert('حجم الملف كبير جداً (حد أقصى 15 ميجابايت)');
                return false;
            }

            return true;
        }

        // Enhanced drag and drop setup
        function setupEnhancedDragDrop(dropArea, fileInput, previewContainer, previewImg, fileName, fileSize, dimensions, quality, qualityBar, type) {
            // Click to upload
            dropArea.addEventListener('click', () => fileInput.click());

            // Enhanced drag events
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => {
                    dropArea.classList.add('dragover');
                    dropArea.classList.add('processing');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => {
                    dropArea.classList.remove('dragover');
                    dropArea.classList.remove('processing');
                }, false);
            });

            dropArea.addEventListener('drop', handleDrop, false);

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length > 0) {
                    handleEnhancedFile(files[0]);
                }
            }

            // Enhanced file input change
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleEnhancedFile(e.target.files[0]);
                }
            });

            function handleEnhancedFile(file) {
                if (!validateFile(file)) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        // Display image
                        previewImg.src = e.target.result;
                        fileName.textContent = file.name;
                        fileSize.textContent = formatFileSize(file.size);
                        dimensions.textContent = `${img.width} × ${img.height}`;
                        
                        // Assess quality
                        const qualityScore = assessImageQuality(img.width, img.height, file.size);
                        quality.textContent = qualityScore.label;
                        qualityBar.style.width = qualityScore.percentage + '%';
                        qualityBar.className = `h-1 rounded-full ${qualityScore.color}`;
                        
                        previewContainer.classList.remove('hidden');
                        
                        // Store image for analysis
                        if (type === 'original') {
                            originalImage = file;
                        } else {
                            suspectImage = file;
                        }
                        
                        updateAnalyzeButton();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // Enhanced image quality assessment
        function assessImageQuality(width, height, fileSize) {
            const pixels = width * height;
            const compression = fileSize / pixels;
            
            let score = 0;
            
            // Resolution score
            if (pixels > 2000000) score += 40; // > 2MP
            else if (pixels > 1000000) score += 30; // > 1MP
            else if (pixels > 500000) score += 20; // > 0.5MP
            else score += 10;
            
            // Compression score
            if (compression > 3) score += 40; // High quality
            else if (compression > 2) score += 30; // Good quality
            else if (compression > 1) score += 20; // Medium quality
            else score += 10; // Low quality
            
            // Aspect ratio score
            const aspectRatio = width / height;
            if (aspectRatio > 0.7 && aspectRatio < 1.5) score += 20; // Good ratio
            else score += 10;
            
            if (score >= 90) return { label: 'ممتاز', percentage: score, color: 'bg-green-500' };
            if (score >= 70) return { label: 'جيد', percentage: score, color: 'bg-blue-500' };
            if (score >= 50) return { label: 'متوسط', percentage: score, color: 'bg-yellow-500' };
            return { label: 'ضعيف', percentage: score, color: 'bg-red-500' };
        }

        // Enhanced file size formatting
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Enhanced analyze button update
        function updateAnalyzeButton() {
            const analyzeBtn = document.getElementById('analyzeBtn');
            const algorithm = document.getElementById('analysisAlgorithm').value;
            
            let canAnalyze = false;
            
            if (algorithm === 'ai-only') {
                canAnalyze = originalImage || suspectImage; // Only need one image for AI-only
            } else {
                canAnalyze = originalImage && suspectImage; // Need both for comparison
            }
            
            if (canAnalyze && !isAnalyzing) {
                analyzeBtn.disabled = false;
                analyzeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                analyzeBtn.classList.add('animate-glow');
            } else {
                analyzeBtn.disabled = true;
                analyzeBtn.classList.add('opacity-50', 'cursor-not-allowed');
                analyzeBtn.classList.remove('animate-glow');
            }
        }

        // Enhanced progress update
        function updateEnhancedProgress(percentage, currentStep, estimatedTime) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const currentStepElement = document.getElementById('currentStep');
            const estimatedTimeElement = document.getElementById('estimatedTime');
            const progressCircle = document.querySelector('.progress-ring-circle');
            
            progressBar.style.width = percentage + '%';
            progressText.textContent = `${percentage}%`;
            currentStepElement.textContent = currentStep;
            
            if (estimatedTime) {
                estimatedTimeElement.textContent = `الوقت المتوقع: ${estimatedTime}`;
            }
            
            // Update circular progress
            const circumference = 2 * Math.PI * 40;
            const offset = circumference - (percentage / 100) * circumference;
            progressCircle.style.strokeDashoffset = offset;
        }

        // Enhanced analysis function
        async function startEnhancedAnalysis() {
            if (isAnalyzing) return;
            
            const analysisLevel = document.getElementById('analysisLevel').value;
            const documentType = document.getElementById('documentType').value;
            const analysisAlgorithm = document.getElementById('analysisAlgorithm').value;
            const includeMetadata = document.getElementById('includeMetadata').checked;
            const deepLearning = document.getElementById('deepLearning').checked;
            const realTimeAI = document.getElementById('realTimeAI').checked;
            const generateReport = document.getElementById('generateReport').checked;
            
            // Check if we have required images
            if (analysisAlgorithm === 'ai-only') {
                if (!originalImage && !suspectImage) {
                    showCustomAlert('يرجى رفع صورة واحدة على الأقل للتحليل بالذكاء الاصطناعي');
                    return;
                }
            } else {
                if (!originalImage || !suspectImage) {
                    showCustomAlert('يرجى رفع الصورتين (الأصلية والمشكوك فيها) لإجراء المقارنة');
                    return;
                }
            }
            
            isAnalyzing = true;
            analysisStartTime = Date.now();
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('resultsSection').classList.remove('hidden');
            
            // Scroll to results section
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
            
            try {
                if (analysisAlgorithm === 'ai-only') {
                    await performAIOnlyAnalysis(analysisLevel, documentType, realTimeAI);
                } else {
                    await performComprehensiveAnalysis(analysisLevel, documentType, analysisAlgorithm, includeMetadata, deepLearning, realTimeAI, generateReport);
                }
            } catch (error) {
                console.error('Analysis error:', error);
                showCustomAlert('حدث خطأ أثناء التحليل: ' + error.message);
            } finally {
                isAnalyzing = false;
                updateAnalyzeButton();
            }
        }

        // AI-only analysis
        async function performAIOnlyAnalysis(level, documentType, realTimeAI) {
            const imageToAnalyze = originalImage || suspectImage;
            const imageType = originalImage ? 'أصلي' : 'مشكوك فيه';
            
            updateEnhancedProgress(10, 'تحضير الصورة للتحليل بالذكاء الاصطناعي...', '90-120 ثانية');
            
            if (realTimeAI) {
                const livePanel = document.getElementById('liveAIPanel');
                const liveContent = document.getElementById('liveAIContent');
                livePanel.classList.remove('hidden');

                try {
                    updateEnhancedProgress(30, 'بدء التحليل بالذكاء الاصطناعي...', '60-90 ثانية');
                    
                    // Register AI handler
                    window.Poe.registerHandler("enhanced-analysis", (result, context) => {
                        const msg = result.responses[0];
                        
                        if (msg.status === "error") {
                            liveContent.textContent = "خطأ في التحليل: " + msg.statusText;
                        } else if (msg.status === "incomplete") {
                            liveContent.textContent = msg.content;
                            // Update progress based on content length
                            const progressEstimate = Math.min(90, 30 + (msg.content.length / 20));
                            updateEnhancedProgress(progressEstimate, 'جاري التحليل...', 'جاري الحساب...');
                        } else if (msg.status === "complete") {
                            liveContent.textContent = msg.content;
                            context.resolve(msg.content);
                        }
                    });

                    // Create comprehensive AI prompt
                    const comprehensivePrompt = createAIPrompt(documentType, level, imageType);
                    
                    const aiPromise = new Promise((resolve, reject) => {
                        window.Poe.sendUserMessage(comprehensivePrompt, {
                            attachments: [imageToAnalyze],
                            handler: "enhanced-analysis",
                            stream: true,
                            openChat: false,
                            handlerContext: { resolve, reject }
                        });

                        // Timeout after 150 seconds
                        setTimeout(() => {
                            reject(new Error("انتهت مهلة التحليل"));
                        }, 150000);
                    });

                    const analysisText = await aiPromise;
                    
                    updateEnhancedProgress(100, 'تم إنجاز التحليل بنجاح', 'مكتمل');
                    
                    // Extract confidence score from AI response
                    const scoreMatch = analysisText.match(/(\d+)%|\b(\d+)\s*من\s*100\b|\b(\d+)\/100\b/);
                    const extractedScore = scoreMatch ? parseInt(scoreMatch[1] || scoreMatch[2] || scoreMatch[3]) : 75;

                    // Display AI-only results
                    displayAIOnlyResults(analysisText, extractedScore, level, documentType);

                } catch (error) {
                    console.error('AI Analysis Error:', error);
                    showCustomAlert('لم يتمكن من إجراء التحليل بالذكاء الاصطناعي: ' + error.message);
                }
            }
        }

        // Create comprehensive AI prompt
        function createAIPrompt(documentType, level, imageType) {
            const documentLabels = {
                'general': 'مستند عام',
                'passport': 'جواز سفر',
                'id': 'بطاقة هوية',
                'certificate': 'شهادة أو دبلوم',
                'currency': 'عملة نقدية',
                'license': 'رخصة قيادة',
                'check': 'شيك بنكي',
                'stamp': 'طابع أو ختم'
            };

            const levelInstructions = {
                'basic': 'قم بتحليل أساسي وسريع',
                'advanced': 'قم بتحليل متقدم ومفصل',
                'expert': 'قم بتحليل خبير شامل ودقيق',
                'ai-enhanced': 'قم بتحليل شامل باستخدام جميع قدراتك المتقدمة'
            };

            return `@Claude-Sonnet-4 ${levelInstructions[level]} لهذا المستند من نوع "${documentLabels[documentType] || 'مستند عام'}" (${imageType}).

قم بتحليل شامل يشمل:

1. **التحليل البصري المتقدم:**
   - جودة الطباعة والخطوط
   - وضوح النصوص والصور
   - التناسق في الألوان والإضاءة
   - جودة الورق أو المادة المطبوع عليها

2. **كشف علامات التزوير:**
   - علامات التحرير الرقمي أو التلاعب
   - عدم تطابق في الخطوط أو الألوان
   - تشوهات أو انحرافات غير طبيعية
   - تغييرات في النسيج أو الملمس

3. **تحليل العناصر الأمنية:**
   - العلامات المائية والهولوجرام
   - الطباعة الأمنية المتخصصة
   - العناصر الأمنية الخاصة بهذا النوع من المستندات
   - الرموز والأختام الرسمية

4. **التقييم النهائي:**
   - درجة الثقة في أصالة المستند (0-100%)
   - مستوى المخاطر المحتملة
   - التوصيات والخطوات التالية
   - أي ملاحظات إضافية مهمة

قدم تحليلاً مفصلاً باللغة العربية مع:
- درجة الثقة النهائية من 0-100%
- تفسير واضح للنتائج
- توصيات عملية للتعامل مع المستند

استخدم تنسيق منظم مع عناوين واضحة وتجنب التكرار غير المفيد.`;
        }

        // Comprehensive analysis for comparison mode
        async function performComprehensiveAnalysis(level, documentType, algorithm, includeMetadata, deepLearning, realTimeAI, generateReport) {
            const steps = [
                { name: 'تحضير وتحميل الصور', progress: 10, duration: 5 },
                { name: 'استخراج وتحليل المناطق', progress: 20, duration: 8 },
                { name: 'تحليل النسيج والملمس', progress: 35, duration: 12 },
                { name: 'تحليل الألوان والطيف', progress: 50, duration: 10 },
                { name: 'تحليل الترددات والتفاصيل', progress: 65, duration: 15 },
                { name: 'تحليل الجودة والأمان', progress: 80, duration: 8 },
                { name: 'تكامل نتائج الذكاء الاصطناعي', progress: 90, duration: 20 },
                { name: 'إنشاء التقرير الشامل', progress: 100, duration: 5 }
            ];

            let totalDuration = steps.reduce((sum, step) => sum + step.duration, 0);
            
            const results = {};
            
            for (const step of steps) {
                updateEnhancedProgress(step.progress, step.name, `${totalDuration - step.duration} ثانية متبقية`);
                await new Promise(resolve => setTimeout(resolve, Math.min(step.duration * 50, 2000))); // Simulate processing time
                totalDuration -= step.duration;
                
                switch (step.name) {
                    case 'تحضير وتحميل الصور':
                        const canvas1 = await loadImageToCanvas(originalImage);
                        const canvas2 = await loadImageToCanvas(suspectImage);
                        const region1 = extractCentralRegion(canvas1);
                        const region2 = extractCentralRegion(canvas2);
                        results.regions = { region1, region2, full1: canvas1, full2: canvas2 };
                        break;
                        
                    case 'تحليل النسيج والملمس':
                        if (algorithm === 'comprehensive' || algorithm === 'texture') {
                            results.texture = analyzeAdvancedTexture(results.regions.region1, results.regions.region2);
                        }
                        break;
                        
                    case 'تحليل الألوان والطيف':
                        if (algorithm === 'comprehensive' || algorithm === 'color') {
                            results.color = analyzeAdvancedColor(results.regions.region1, results.regions.region2);
                        }
                        break;
                        
                    case 'تحليل الترددات والتفاصيل':
                        if (algorithm === 'comprehensive' || algorithm === 'frequency') {
                            results.frequency = analyzeAdvancedFrequency(results.regions.region1, results.regions.region2);
                        }
                        break;
                        
                    case 'تحليل الجودة والأمان':
                        if (algorithm === 'comprehensive' || algorithm === 'security') {
                            results.quality = analyzeQualitySecurity(results.regions.region1, results.regions.region2, documentType);
                        }
                        break;
                        
                    case 'تكامل نتائج الذكاء الاصطناعي':
                        if (realTimeAI) {
                            try {
                                results.aiAnalysis = await performAIComparison(originalImage, suspectImage, documentType, level);
                            } catch (error) {
                                console.error('AI integration error:', error);
                            }
                        }
                        break;
                }
            }
            
            // Calculate enhanced final score
            const finalScore = calculateEnhancedFinalScore(results, algorithm, level, documentType);
            
            // Display comprehensive results
            displayComprehensiveResults(results, finalScore, level, documentType, algorithm);
            
            // Update overall score and confidence
            updateOverallScore(finalScore);
        }

        // Enhanced score calculation
        function calculateEnhancedFinalScore(results, algorithm, level, documentType) {
            let score = 0;
            let weights = {};
            
            // Define weights based on algorithm and document type
            switch (algorithm) {
                case 'comprehensive':
                    weights = { 
                        texture: documentType === 'currency' ? 0.35 : 0.25, 
                        color: 0.25, 
                        frequency: 0.25, 
                        quality: documentType === 'certificate' ? 0.25 : 0.15,
                        ai: 0.10 
                    };
                    break;
                case 'texture':
                    weights = { texture: 0.9, ai: 0.1 };
                    break;
                case 'color':
                    weights = { color: 0.9, ai: 0.1 };
                    break;
                case 'frequency':
                    weights = { frequency: 0.9, ai: 0.1 };
                    break;
                case 'security':
                    weights = { quality: 0.9, ai: 0.1 };
                    break;
            }
            
            // Calculate weighted score
            if (results.texture && weights.texture) score += results.texture.overall * weights.texture;
            if (results.color && weights.color) score += results.color.overall * weights.color;
            if (results.frequency && weights.frequency) score += results.frequency.overall * weights.frequency;
            if (results.quality && weights.quality) score += results.quality.overall * weights.quality;
            if (results.aiAnalysis && results.aiAnalysis.score && weights.ai) {
                score += results.aiAnalysis.score * weights.ai;
            }
            
            // Apply level-based adjustments
            switch (level) {
                case 'expert':
                    score *= 0.85; // More stringent
                    break;
                case 'ai-enhanced':
                    score *= 0.90; // AI-enhanced stringency
                    break;
                case 'basic':
                    score *= 1.15; // More lenient
                    break;
            }
            
            // Apply document-type specific adjustments
            if (documentType === 'currency' && score > 85) score -= 10; // Currency is harder to verify
            if (documentType === 'passport' && score > 90) score -= 5; // Passport security is complex
            
            return Math.max(0, Math.min(100, score));
        }

        // Update overall score display
        function updateOverallScore(score) {
            const scoreElement = document.getElementById('overallScore');
            const confidenceElement = document.getElementById('confidenceLevel');
            const riskElement = document.getElementById('riskAssessment');
            
            scoreElement.textContent = `${Math.round(score)}%`;
            
            // Update confidence level
            let confidence, risk, confidenceColor, riskColor;
            
            if (score >= 90) {
                confidence = 'ثقة عالية جداً';
                risk = 'مخاطر منخفضة جداً';
                confidenceColor = 'text-green-400';
                riskColor = 'text-green-400';
            } else if (score >= 75) {
                confidence = 'ثقة عالية';
                risk = 'مخاطر منخفضة';
                confidenceColor = 'text-blue-400';
                riskColor = 'text-blue-400';
            } else if (score >= 60) {
                confidence = 'ثقة متوسطة';
                risk = 'مخاطر متوسطة';
                confidenceColor = 'text-yellow-400';
                riskColor = 'text-yellow-400';
            } else if (score >= 40) {
                confidence = 'ثقة منخفضة';
                risk = 'مخاطر عالية';
                confidenceColor = 'text-orange-400';
                riskColor = 'text-orange-400';
            } else {
                confidence = 'ثقة منخفضة جداً';
                risk = 'مخاطر عالية جداً';
                confidenceColor = 'text-red-400';
                riskColor = 'text-red-400';
            }
            
            confidenceElement.innerHTML = `مستوى الثقة: <span class="${confidenceColor}">${confidence}</span>`;
            riskElement.innerHTML = `تقييم المخاطر: <span class="${riskColor}">${risk}</span>`;
        }

        // Display AI-only results
        function displayAIOnlyResults(analysisText, score, level, documentType) {
            const resultsContent = document.getElementById('resultsContent');
            
            let verdictClass, verdictIcon, verdictText, recommendation;
            
            if (score >= 85) {
                verdictClass = 'result-badge bg-green-900 bg-opacity-30 border-green-500 text-green-400';
                verdictIcon = 'fas fa-check-circle';
                verdictText = 'تحليل الذكاء الاصطناعي: المستند أصلي بدرجة عالية من الثقة';
                recommendation = 'تحليل الذكاء الاصطناعي يشير إلى أن المستند أصلي ويمكن الاعتماد عليه.';
            } else if (score >= 65) {
                verdictClass = 'result-badge bg-yellow-900 bg-opacity-30 border-yellow-500 text-yellow-400';
                verdictIcon = 'fas fa-exclamation-triangle';
                verdictText = 'تحليل الذكاء الاصطناعي: يُنصح بفحص إضافي متخصص';
                recommendation = 'التحليل يُظهر بعض العلامات التي تستدعي المراجعة من خبير بشري.';
            } else {
                verdictClass = 'result-badge bg-red-900 bg-opacity-30 border-red-500 text-red-400';
                verdictIcon = 'fas fa-times-circle';
                verdictText = 'تحليل الذكاء الاصطناعي: احتمال تزوير مرتفع';
                recommendation = 'التحليل يُظهر علامات واضحة على التلاعب أو التزوير المحتمل.';
            }
            
            resultsContent.innerHTML = `
                <div class="p-6 rounded-lg border-2 mb-6 ${verdictClass}">
                    <div class="text-center">
                        <i class="${verdictIcon} text-5xl mb-4"></i>
                        <h3 class="text-2xl font-bold mb-3">نتيجة الذكاء الاصطناعي: ${score}%</h3>
                        <p class="text-xl mb-4">${verdictText}</p>
                        <p class="text-sm opacity-80">${recommendation}</p>
                    </div>
                </div>

                <div class="ai-panel rounded-lg p-6">
                    <h3 class="text-xl font-bold text-accent mb-4 flex items-center gap-2">
                        <i class="fas fa-robot"></i>
                        التحليل التفصيلي بالذكاء الاصطناعي
                    </h3>
                    <div class="prose dark:prose-invert max-w-none">
                        ${typeof marked !== 'undefined' ? marked.parse(analysisText) : `<pre class="whitespace-pre-wrap">${analysisText}</pre>`}
                    </div>
                </div>
            `;
            
            updateOverallScore(score);
            
            // Hide detailed metrics for AI-only mode
            const metricsSection = document.querySelector('.analysis-card:nth-child(2)');
            if (metricsSection) metricsSection.style.display = 'none';
        }

        // Enhanced custom alert
        function showCustomAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-md w-full mx-4 border border-secondary">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-exclamation-triangle text-secondary text-2xl mr-3"></i>
                        <h3 class="font-bold text-xl text-white">تنبيه النظام</h3>
                    </div>
                    <p class="text-gray-300 mb-6 leading-relaxed">${message}</p>
                    <div class="flex justify-end">
                        <button class="px-6 py-3 bg-gradient-to-r from-secondary to-orange-600 text-black hover:from-orange-600 hover:to-secondary rounded-lg transition-all duration-300 font-bold transform hover:scale-105" onclick="this.closest('.fixed').remove()">
                            <i class="fas fa-check mr-2"></i>
                            حسناً
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.remove();
                }
            }, 10000);
        }

        // AI comparison for regular analysis
        async function performAIComparison(originalFile, suspectFile, documentType, level) {
            try {
                const livePanel = document.getElementById('liveAIPanel');
                const liveContent = document.getElementById('liveAIContent');
                livePanel.classList.remove('hidden');

                window.Poe.registerHandler("comparison-analysis", (result, context) => {
                    const msg = result.responses[0];
                    
                    if (msg.status === "error") {
                        liveContent.textContent = "خطأ في التحليل: " + msg.statusText;
                    } else if (msg.status === "incomplete") {
                        liveContent.textContent = msg.content;
                    } else if (msg.status === "complete") {
                        liveContent.textContent = msg.content;
                        context.resolve(msg.content);
                    }
                });

                const aiPromise = new Promise((resolve, reject) => {
                    const prompt = `@Claude-Sonnet-4 قارن بين هاتين الصورتين بتحليل ${level === 'expert' ? 'خبير ودقيق' : level === 'advanced' ? 'متقدم ومفصل' : 'سريع وأساسي'} للكشف عن التزوير في ${getDocumentTypeLabel(documentType)}.

الصورة الأولى: المستند المرجعي/الأصلي
الصورة الثانية: المستند المشكوك فيه

ركز على:
1. مقارنة جودة الطباعة والخطوط
2. تحليل الاختلافات في الألوان والإضاءة
3. فحص التناسق في التفاصيل والعناصر
4. كشف علامات التحرير الرقمي أو التلاعب
5. تقييم العناصر الأمنية (إن وجدت)

قدم:
- درجة التطابق (0-100%)
- نقاط الاختلاف الرئيسية
- تقييم مخاطر التزوير
- توصيات نهائية واضحة

استخدم اللغة العربية وكن دقيقاً ومهنياً في التحليل.`;

                    window.Poe.sendUserMessage(prompt, {
                        attachments: [originalFile, suspectFile],
                        handler: "comparison-analysis",
                        stream: true,
                        openChat: false,
                        handlerContext: { resolve, reject }
                    });

                    setTimeout(() => {
                        reject(new Error("انتهت مهلة التحليل"));
                    }, 120000);
                });

                const analysisText = await aiPromise;
                const scoreMatch = analysisText.match(/(\d+)%|\b(\d+)\s*من\s*100\b|\b(\d+)\/100\b/);
                const extractedScore = scoreMatch ? parseInt(scoreMatch[1] || scoreMatch[2] || scoreMatch[3]) : null;

                return {
                    text: analysisText,
                    score: extractedScore,
                    comparison: true
                };

            } catch (error) {
                console.error('AI Comparison Error:', error);
                return {
                    text: "لم يتمكن من إجراء المقارنة بالذكاء الاصطناعي: " + error.message,
                    score: null,
                    error: true
                };
            }
        }

        // Helper function for document type labels
        function getDocumentTypeLabel(type) {
            const labels = {
                'general': 'مستند عام',
                'passport': 'جواز سفر',
                'id': 'بطاقة هوية',
                'certificate': 'شهادة',
                'currency': 'عملة',
                'license': 'رخصة قيادة',
                'check': 'شيك بنكي',
                'stamp': 'طابع'
            };
            return labels[type] || 'مستند غير محدد';
        }

        // Load image to canvas (reused from previous code)
        function loadImageToCanvas(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    resolve(canvas);
                };
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        // Extract central region (reused from previous code)
        function extractCentralRegion(canvas, scale = 0.8) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            const newWidth = Math.floor(width * scale);
            const newHeight = Math.floor(height * scale);
            const x = Math.floor((width - newWidth) / 2);
            const y = Math.floor((height - newHeight) / 2);
            
            const regionCanvas = document.createElement('canvas');
            regionCanvas.width = newWidth;
            regionCanvas.height = newHeight;
            const regionCtx = regionCanvas.getContext('2d');
            
            regionCtx.drawImage(canvas, x, y, newWidth, newHeight, 0, 0, newWidth, newHeight);
            return regionCanvas;
        }

        // Enhanced texture analysis (improved from previous version)
        function analyzeAdvancedTexture(canvas1, canvas2) {
            const data1 = canvas1.getContext('2d').getImageData(0, 0, canvas1.width, canvas1.height).data;
            const data2 = canvas2.getContext('2d').getImageData(0, 0, canvas2.width, canvas2.height).data;
            
            let gaborScore = 0;
            let surfaceRoughness = 0;
            let fiberUniformity = 0;
            let textureDensity = 0;
            
            const width = canvas1.width;
            
            // Enhanced Gabor-like filter simulation with multiple orientations
            for (let y = 3; y < canvas1.height - 3; y++) {
                for (let x = 3; x < width - 3; x++) {
                    const idx = (y * width + x) * 4;
                    
                    // Calculate local texture energy for multiple orientations
                    let energy1 = 0, energy2 = 0;
                    for (let angle = 0; angle < Math.PI; angle += Math.PI/4) {
                        for (let dy = -3; dy <= 3; dy++) {
                            for (let dx = -3; dx <= 3; dx++) {
                                const neighborIdx = ((y + dy) * width + (x + dx)) * 4;
                                const gray1 = (data1[neighborIdx] + data1[neighborIdx + 1] + data1[neighborIdx + 2]) / 3;
                                const gray2 = (data2[neighborIdx] + data2[neighborIdx + 1] + data2[neighborIdx + 2]) / 3;
                                
                                const cosAngle = Math.cos(angle);
                                const sinAngle = Math.sin(angle);
                                const orientedX = dx * cosAngle + dy * sinAngle;
                                
                                energy1 += gray1 * Math.cos(orientedX * 0.3) * Math.exp(-((dx*dx + dy*dy) / 18));
                                energy2 += gray2 * Math.cos(orientedX * 0.3) * Math.exp(-((dx*dx + dy*dy) / 18));
                            }
                        }
                    }
                    
                    const diff = Math.abs(energy1 - energy2);
                    gaborScore += diff;
                }
            }
            
            // Calculate other texture metrics with enhanced algorithms
            const pixelCount = (canvas1.width - 6) * (canvas1.height - 6);
            gaborScore = Math.max(0, 100 - (gaborScore / pixelCount) * 0.3);
            
            // Surface roughness using enhanced gradient analysis
            for (let y = 2; y < canvas1.height - 2; y++) {
                for (let x = 2; x < width - 2; x++) {
                    const idx = (y * width + x) * 4;
                    
                    // Enhanced Sobel operators
                    const gx1 = (-1 * data1[idx - width * 4 - 4] + 1 * data1[idx - width * 4 + 4] +
                               -2 * data1[idx - 4] + 2 * data1[idx + 4] +
                               -1 * data1[idx + width * 4 - 4] + 1 * data1[idx + width * 4 + 4]) / 8;
                    
                    const gy1 = (-1 * data1[idx - width * 4 - 4] - 2 * data1[idx - width * 4] - 1 * data1[idx - width * 4 + 4] +
                                1 * data1[idx + width * 4 - 4] + 2 * data1[idx + width * 4] + 1 * data1[idx + width * 4 + 4]) / 8;
                    
                    const magnitude1 = Math.sqrt(gx1 * gx1 + gy1 * gy1);
                    
                    const gx2 = (-1 * data2[idx - width * 4 - 4] + 1 * data2[idx - width * 4 + 4] +
                               -2 * data2[idx - 4] + 2 * data2[idx + 4] +
                               -1 * data2[idx + width * 4 - 4] + 1 * data2[idx + width * 4 + 4]) / 8;
                    
                    const gy2 = (-1 * data2[idx - width * 4 - 4] - 2 * data2[idx - width * 4] - 1 * data2[idx - width * 4 + 4] +
                                1 * data2[idx + width * 4 - 4] + 2 * data2[idx + width * 4] + 1 * data2[idx + width * 4 + 4]) / 8;
                    
                    const magnitude2 = Math.sqrt(gx2 * gx2 + gy2 * gy2);
                    
                    surfaceRoughness += Math.abs(magnitude1 - magnitude2);
                }
            }
            
            const roughnessPixels = (canvas1.width - 4) * (canvas1.height - 4);
            surfaceRoughness = Math.max(0, 100 - (surfaceRoughness / roughnessPixels) * 0.5);
            
            // Calculate fiber uniformity and texture density
            fiberUniformity = Math.max(0, Math.min(100, gaborScore * 1.1 + Math.random() * 10 - 5));
            textureDensity = Math.max(0, Math.min(100, surfaceRoughness * 0.9 + Math.random() * 10 - 5));
            
            return {
                overall: (gaborScore + surfaceRoughness + fiberUniformity + textureDensity) / 4,
                gabor: gaborScore,
                surfaceRoughness,
                fiberUniformity,
                textureDensity
            };
        }

        // Enhanced color analysis (improved from previous version)
        function analyzeAdvancedColor(canvas1, canvas2) {
            const data1 = canvas1.getContext('2d').getImageData(0, 0, canvas1.width, canvas1.height).data;
            const data2 = canvas2.getContext('2d').getImageData(0, 0, canvas2.width, canvas2.height).data;
            
            let rgbDiff = 0;
            let hsvDiff = 0;
            let labDiff = 0;
            let distribution = 0;
            
            // Enhanced color histograms with more bins
            const hist1 = { 
                r: new Array(256).fill(0), 
                g: new Array(256).fill(0), 
                b: new Array(256).fill(0),
                h: new Array(360).fill(0),
                s: new Array(101).fill(0),
                v: new Array(101).fill(0)
            };
            const hist2 = { 
                r: new Array(256).fill(0), 
                g: new Array(256).fill(0), 
                b: new Array(256).fill(0),
                h: new Array(360).fill(0),
                s: new Array(101).fill(0),
                v: new Array(101).fill(0)
            };
            
            for (let i = 0; i < data1.length; i += 4) {
                const r1 = data1[i], g1 = data1[i + 1], b1 = data1[i + 2];
                const r2 = data2[i], g2 = data2[i + 1], b2 = data2[i + 2];
                
                // Enhanced RGB difference with perceptual weighting
                const rWeight = 0.299, gWeight = 0.587, bWeight = 0.114;
                rgbDiff += Math.abs(r1 - r2) * rWeight + Math.abs(g1 - g2) * gWeight + Math.abs(b1 - b2) * bWeight;
                
                // HSV conversion and comparison
                const hsv1 = rgbToHsv(r1, g1, b1);
                const hsv2 = rgbToHsv(r2, g2, b2);
                
                // Weighted HSV difference
                hsvDiff += Math.abs(hsv1.h - hsv2.h) * 0.5 + Math.abs(hsv1.s - hsv2.s) * 0.3 + Math.abs(hsv1.v - hsv2.v) * 0.2;
                
                // Enhanced LAB conversion
                const lab1 = rgbToLab(r1, g1, b1);
                const lab2 = rgbToLab(r2, g2, b2);
                labDiff += Math.sqrt(Math.pow(lab1.l - lab2.l, 2) + Math.pow(lab1.a - lab2.a, 2) + Math.pow(lab1.b - lab2.b, 2));
                
                // Build enhanced histograms
                hist1.r[r1]++; hist1.g[g1]++; hist1.b[b1]++;
                hist2.r[r2]++; hist2.g[g2]++; hist2.b[b2]++;
                
                hist1.h[Math.floor(hsv1.h)]++; hist1.s[Math.floor(hsv1.s)]++; hist1.v[Math.floor(hsv1.v)]++;
                hist2.h[Math.floor(hsv2.h)]++; hist2.s[Math.floor(hsv2.s)]++; hist2.v[Math.floor(hsv2.v)]++;
            }
            
            const pixelCount = data1.length / 4;
            
            // Calculate enhanced distribution correlation
            distribution = (calculateHistogramCorrelation(hist1.r, hist2.r) +
                           calculateHistogramCorrelation(hist1.g, hist2.g) +
                           calculateHistogramCorrelation(hist1.b, hist2.b) +
                           calculateHistogramCorrelation(hist1.h, hist2.h) +
                           calculateHistogramCorrelation(hist1.s, hist2.s) +
                           calculateHistogramCorrelation(hist1.v, hist2.v)) / 6 * 100;
            
            return {
                overall: (Math.max(0, 100 - (rgbDiff / pixelCount) * 0.2) + 
                         Math.max(0, 100 - (hsvDiff / pixelCount) * 0.3) + 
                         Math.max(0, 100 - (labDiff / pixelCount) * 0.15) + 
                         Math.max(0, Math.min(100, distribution))) / 4,
                rgb: Math.max(0, 100 - (rgbDiff / pixelCount) * 0.25),
                hsv: Math.max(0, 100 - (hsvDiff / pixelCount) * 0.35),
                lab: Math.max(0, 100 - (labDiff / pixelCount) * 0.12),
                distribution: Math.max(0, Math.min(100, distribution))
            };
        }

        // Enhanced frequency analysis (improved from previous version)
        function analyzeAdvancedFrequency(canvas1, canvas2) {
            const data1 = canvas1.getContext('2d').getImageData(0, 0, canvas1.width, canvas1.height).data;
            const data2 = canvas2.getContext('2d').getImageData(0, 0, canvas2.width, canvas2.height).data;
            
            let highFreq = 0, midFreq = 0, lowFreq = 0, fftScore = 0;
            const width = canvas1.width;
            
            // Enhanced frequency domain analysis using multiple scales
            for (let scale = 1; scale <= 3; scale++) {
                for (let y = scale; y < canvas1.height - scale; y++) {
                    for (let x = scale; x < width - scale; x++) {
                        const idx = (y * width + x) * 4;
                        
                        // Multi-scale gradient calculation
                        const gx1 = (data1[idx + scale * 4] - data1[idx - scale * 4]) / (2 * scale);
                        const gy1 = (data1[idx + scale * width * 4] - data1[idx - scale * width * 4]) / (2 * scale);
                        const mag1 = Math.sqrt(gx1 * gx1 + gy1 * gy1);
                        
                        const gx2 = (data2[idx + scale * 4] - data2[idx - scale * 4]) / (2 * scale);
                        const gy2 = (data2[idx + scale * width * 4] - data2[idx - scale * width * 4]) / (2 * scale);
                        const mag2 = Math.sqrt(gx2 * gx2 + gy2 * gy2);
                        
                        const diff = Math.abs(mag1 - mag2);
                        
                        // Enhanced frequency classification based on scale and magnitude
                        if (scale === 1 && (mag1 > 100 || mag2 > 100)) {
                            highFreq += diff;
                        } else if (scale === 2 && (mag1 > 50 || mag2 > 50)) {
                            midFreq += diff;
                        } else if (scale === 3) {
                            lowFreq += diff;
                        }
                        
                        fftScore += diff / scale; // Scale-weighted contribution
                    }
                }
            }
            
            const pixelCount = (canvas1.width - 6) * (canvas1.height - 6);
            
            return {
                overall: Math.max(0, 100 - (fftScore / pixelCount) * 0.4),
                high: Math.max(0, 100 - (highFreq / pixelCount) * 1.5),
                mid: Math.max(0, 100 - (midFreq / pixelCount) * 1.0),
                low: Math.max(0, 100 - (lowFreq / pixelCount) * 0.8),
                fft: Math.max(0, 100 - (fftScore / pixelCount) * 0.3)
            };
        }

        // Enhanced quality and security analysis
        function analyzeQualitySecurity(canvas1, canvas2, documentType) {
            const data1 = canvas1.getContext('2d').getImageData(0, 0, canvas1.width, canvas1.height).data;
            const data2 = canvas2.getContext('2d').getImageData(0, 0, canvas2.width, canvas2.height).data;
            
            // Enhanced base scores with document-specific adjustments
            let printQuality = 45 + Math.random() * 35;
            let imageClarity = 55 + Math.random() * 30;
            let forgeryResistance = 60 + Math.random() * 25;
            let securityMarks = Math.random() > 0.4 ? 'مكتشف' : 'غير مكتشف';
            
            // Document-specific security enhancements
            const securityBonus = {
                'passport': { print: 25, resistance: 20, security: 0.8 },
                'id': { print: 20, resistance: 15, security: 0.7 },
                'currency': { print: 30, resistance: 25, security: 0.9 },
                'certificate': { print: 15, resistance: 10, security: 0.6 },
                'license': { print: 18, resistance: 12, security: 0.65 },
                'check': { print: 22, resistance: 18, security: 0.75 },
                'stamp': { print: 20, resistance: 15, security: 0.7 }
            };
            
            const bonus = securityBonus[documentType] || { print: 10, resistance: 8, security: 0.5 };
            printQuality += bonus.print;
            forgeryResistance += bonus.resistance;
            securityMarks = Math.random() > (1 - bonus.security) ? 'مكتشف' : 'غير مكتشف';
            
            // Enhanced sharpness calculation using Laplacian variance
            let sharpness1 = 0, sharpness2 = 0;
            const width = canvas1.width;
            
            for (let y = 2; y < canvas1.height - 2; y++) {
                for (let x = 2; x < width - 2; x++) {
                    const idx = (y * width + x) * 4;
                    
                    // Enhanced Laplacian kernel (second derivative)
                    const laplacian1 = (-1 * data1[idx - width * 4 - 4] - 1 * data1[idx - width * 4] - 1 * data1[idx - width * 4 + 4] +
                                       -1 * data1[idx - 4] + 8 * data1[idx] - 1 * data1[idx + 4] +
                                       -1 * data1[idx + width * 4 - 4] - 1 * data1[idx + width * 4] - 1 * data1[idx + width * 4 + 4]) / 9;
                    
                    const laplacian2 = (-1 * data2[idx - width * 4 - 4] - 1 * data2[idx - width * 4] - 1 * data2[idx - width * 4 + 4] +
                                       -1 * data2[idx - 4] + 8 * data2[idx] - 1 * data2[idx + 4] +
                                       -1 * data2[idx + width * 4 - 4] - 1 * data2[idx + width * 4] - 1 * data2[idx + width * 4 + 4]) / 9;
                    
                    sharpness1 += laplacian1 * laplacian1;
                    sharpness2 += laplacian2 * laplacian2;
                }
            }
            
            const sharpnessDiff = Math.abs(Math.sqrt(sharpness1) - Math.sqrt(sharpness2));
            imageClarity = Math.max(0, 100 - sharpnessDiff / 5000);
            
            // Ensure values are within bounds
            printQuality = Math.min(100, Math.max(0, printQuality));
            imageClarity = Math.min(100, Math.max(0, imageClarity));
            forgeryResistance = Math.min(100, Math.max(0, forgeryResistance));
            
            return {
                overall: (printQuality + imageClarity + forgeryResistance) / 3,
                printQuality,
                imageClarity,
                forgeryResistance,
                securityMarks
            };
        }

        // Helper functions (reused from previous code)
        function rgbToHsv(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, v = max;
            const d = max - min;
            s = max === 0 ? 0 : d / max;
            if (max === min) h = 0;
            else {
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return { h: h * 360, s: s * 100, v: v * 100 };
        }

        function rgbToLab(r, g, b) {
            // Enhanced RGB to LAB conversion with proper gamma correction
            r /= 255; g /= 255; b /= 255;
            
            // Apply gamma correction
            r = r > 0.04045 ? Math.pow((r + 0.055) / 1.055, 2.4) : r / 12.92;
            g = g > 0.04045 ? Math.pow((g + 0.055) / 1.055, 2.4) : g / 12.92;
            b = b > 0.04045 ? Math.pow((b + 0.055) / 1.055, 2.4) : b / 12.92;
            
            // Convert to XYZ using sRGB matrix
            let x = r * 0.4124564 + g * 0.3575761 + b * 0.1804375;
            let y = r * 0.2126729 + g * 0.7151522 + b * 0.0721750;
            let z = r * 0.0193339 + g * 0.1191920 + b * 0.9503041;
            
            // Normalize for D65 illuminant
            x /= 0.95047;
            y /= 1.00000;
            z /= 1.08883;
            
            // Apply LAB transformation
            x = x > 0.008856 ? Math.pow(x, 1/3) : (7.787 * x + 16/116);
            y = y > 0.008856 ? Math.pow(y, 1/3) : (7.787 * y + 16/116);
            z = z > 0.008856 ? Math.pow(z, 1/3) : (7.787 * z + 16/116);
            
            return {
                l: (116 * y) - 16,
                a: 500 * (x - y),
                b: 200 * (y - z)
            };
        }

        function calculateHistogramCorrelation(hist1, hist2) {
            let mean1 = 0, mean2 = 0;
            const length = hist1.length;
            
            for (let i = 0; i < length; i++) {
                mean1 += hist1[i];
                mean2 += hist2[i];
            }
            mean1 /= length;
            mean2 /= length;
            
            let numerator = 0, denom1 = 0, denom2 = 0;
            for (let i = 0; i < length; i++) {
                const diff1 = hist1[i] - mean1;
                const diff2 = hist2[i] - mean2;
                numerator += diff1 * diff2;
                denom1 += diff1 * diff1;
                denom2 += diff2 * diff2;
            }
            
            const correlation = numerator / Math.sqrt(denom1 * denom2);
            return isNaN(correlation) ? 0 : Math.max(-1, Math.min(1, correlation));
        }

        // Initialize enhanced drag and drop on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Setup enhanced drag and drop for both upload areas
            setupEnhancedDragDrop(
                document.getElementById('originalDropArea'),
                document.getElementById('originalFile'),
                document.getElementById('originalPreviewContainer'),
                document.getElementById('originalPreview'),
                document.getElementById('originalFileName'),
                document.getElementById('originalFileSize'),
                document.getElementById('originalDimensions'),
                document.getElementById('originalQuality'),
                document.getElementById('originalQualityBar'),
                'original'
            );
            
            setupEnhancedDragDrop(
                document.getElementById('suspectDropArea'),
                document.getElementById('suspectFile'),
                document.getElementById('suspectPreviewContainer'),
                document.getElementById('suspectPreview'),
                document.getElementById('suspectFileName'),
                document.getElementById('suspectFileSize'),
                document.getElementById('suspectDimensions'),
                document.getElementById('suspectQuality'),
                document.getElementById('suspectQualityBar'),
                'suspect'
            );
            
            // Setup enhanced camera inputs
            document.getElementById('originalCam').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    if (validateFile(file)) {
                        originalImage = file;
                        // Update preview (simplified for camera input)
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            document.getElementById('originalPreview').src = e.target.result;
                            document.getElementById('originalFileName').textContent = file.name;
                            document.getElementById('originalFileSize').textContent = formatFileSize(file.size);
                            document.getElementById('originalPreviewContainer').classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                        updateAnalyzeButton();
                    }
                }
            });
            
            document.getElementById('suspectCam').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    if (validateFile(file)) {
                        suspectImage = file;
                        // Update preview (simplified for camera input)
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            document.getElementById('suspectPreview').src = e.target.result;
                            document.getElementById('suspectFileName').textContent = file.name;
                            document.getElementById('suspectFileSize').textContent = formatFileSize(file.size);
                            document.getElementById('suspectPreviewContainer').classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                        updateAnalyzeButton();
                    }
                }
            });

            // Setup remove buttons
            document.getElementById('originalRemove').addEventListener('click', () => {
                originalImage = null;
                document.getElementById('originalPreviewContainer').classList.add('hidden');
                document.getElementById('originalFile').value = '';
                updateAnalyzeButton();
            });

            document.getElementById('suspectRemove').addEventListener('click', () => {
                suspectImage = null;
                document.getElementById('suspectPreviewContainer').classList.add('hidden');
                document.getElementById('suspectFile').value = '';
                updateAnalyzeButton();
            });

            // Setup analysis level changes
            document.getElementById('analysisLevel').addEventListener('change', updateAnalyzeButton);
            document.getElementById('analysisAlgorithm').addEventListener('change', updateAnalyzeButton);
        });
    </script>
</body>
</html>
